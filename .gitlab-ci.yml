# GitLab CI/CD Pipeline for ALCIS
stages:
  - security
  - quality
  - test
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

cache:
  paths:
    - .cache/pip
    - venv/

# Security Scanning
security:bandit:
  stage: security
  image: python:$PYTHON_VERSION
  before_script:
    - pip install bandit safety
  script:
    - bandit -r src/ -f json -o bandit-report.json
    - safety check --json --output safety-report.json
  artifacts:
    reports:
      security: bandit-report.json
    paths:
      - bandit-report.json
      - safety-report.json
    expire_in: 1 week
  allow_failure: true

security:semgrep:
  stage: security
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto src/ --json --output=semgrep-report.json
  artifacts:
    paths:
      - semgrep-report.json
    expire_in: 1 week
  allow_failure: true

# Code Quality
quality:lint:
  stage: quality
  image: python:$PYTHON_VERSION
  before_script:
    - pip install black flake8 mypy isort
    - pip install -r requirements.txt
  script:
    - black --check --diff src/ tests/
    - isort --check-only --diff src/ tests/
    - flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503
    - mypy src/ --ignore-missing-imports
  artifacts:
    reports:
      codequality: codequality.json
    expire_in: 1 week

# Testing
test:unit:
  stage: test
  image: python:$PYTHON_VERSION
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_DB: alcis_test
    POSTGRES_USER: alcis
    POSTGRES_PASSWORD: alcis_test
    DATABASE_URL: "postgresql://alcis:alcis_test@postgres:5432/alcis_test"
    REDIS_URL: "redis://redis:6379/1"
    SECRET_KEY: "test-secret-key"
    ENCRYPTION_KEY: "dGVzdC1lbmNyeXB0aW9uLWtleS0zMi1ieXRlcw=="
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl
    - pip install -r requirements.txt
    - playwright install chromium
  script:
    - pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=html --junitxml=report.xml
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week

test:integration:
  stage: test
  image: python:$PYTHON_VERSION
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_DB: alcis_test
    POSTGRES_USER: alcis
    POSTGRES_PASSWORD: alcis_test
    DATABASE_URL: "postgresql://alcis:alcis_test@postgres:5432/alcis_test"
    REDIS_URL: "redis://redis:6379/1"
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl
    - pip install -r requirements.txt
    - playwright install chromium
  script:
    - pytest tests/integration/ -v --maxfail=5
  artifacts:
    reports:
      junit: integration-report.xml
    expire_in: 1 week

# Build
build:package:
  stage: build
  image: python:$PYTHON_VERSION
  before_script:
    - pip install build twine
  script:
    - python -m build
    - twine check dist/*
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  only:
    - main
    - develop

# Deploy to Staging
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging environment..."
    - curl -X POST "$STAGING_WEBHOOK_URL" -H "Authorization: Bearer $STAGING_TOKEN"
  environment:
    name: staging
    url: https://staging.alcis.example.com
  only:
    - develop

# Deploy to Production
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production environment..."
    - curl -X POST "$PRODUCTION_WEBHOOK_URL" -H "Authorization: Bearer $PRODUCTION_TOKEN"
  environment:
    name: production
    url: https://alcis.example.com
  when: manual
  only:
    - main